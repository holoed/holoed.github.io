<!doctype html>
  <html>
    <head>
      <meta http-equiv="Cache-control" content="no-cache">
      <link rel="stylesheet" href="javascripts/xterm/dist/xterm.css" />
      <script src="javascripts/xterm/dist/xterm.js"></script>
      <script src="javascripts/systemjs/dist/system.js"></script>
    </head>
    <body style="background-color:black;">
      <div id="terminal"></div>
      <script>
       SystemJS.import('./javascripts/CodeV4/Externals.js').then(function (ext) {
       SystemJS.import('./javascripts/CodeV4/Base.js');
       SystemJS.import('./javascripts/CodeV4/Parser.js').then(function (parser) {
       SystemJS.import('./javascripts/CodeV4/CodeGenerator.js').then(function (codegen) {

       var term = new Terminal({
          cursorBlink: true,  // Do not blink the terminal's cursor
          cols: 120,  // Set the terminal's width to 120 columns
          rows: 80  // Set the terminal's height to 80 rows
          });
        term.open(document.getElementById('terminal'));

        var shellprompt = 'junior> ';

        term.prompt = function () {
          term.write(shellprompt);
        };

        var prevCommand = "";
        var currentCommand = "";

        term.prompt();
        term.on('key', function (key, ev) {
            var printable = (
              !ev.altKey && !ev.altGraphKey && !ev.ctrlKey && !ev.metaKey
            );

            if (ev.keyCode == 13) {
              term.write('')
              var progAst = (ext.fst ((ext.head (((parser.parse (parser.progP)) ((ext.stringToCharList (currentCommand))))))));
              var js = codegen.toJs(progAst)
              var ret = eval("(function(){ " + js + " })()");
              term.writeln("\r\n" + ret.toString())
              term.prompt();
              prevCommand = currentCommand;
              currentCommand = "";
            } else if (ev.keyCode == 8) {
             // Do not delete the prompt
              if (term.buffer.x > shellprompt.length) {
                currentCommand = currentCommand.substring(0, currentCommand.length-1);
                term.write('\b \b');
              }
            } else if (ev.keyCode == 38) {
              currentCommand = prevCommand;
              term.write(currentCommand);
            } else if (ev.keyCode == 40) {
              console.log("not implemented")
            }else if (printable) {
              currentCommand = currentCommand + key;
              term.write(key);
            }
          });
        });
      });
    });
      </script>
    </body>
  </html>
